import { query } from './connection';
import * as fs from 'fs';
import * as path from 'path';
import * as bcrypt from 'bcrypt';

export const initializeDatabase = async () => {
  try {
    console.log('[DB] Initializing database...');

    // Read and execute schema
    const __dirname = import.meta.dirname;
    const schemaPath = path.join(__dirname, 'schema.sql');
    const schema = fs.readFileSync(schemaPath, 'utf-8');

    // Split and execute each statement
    const statements = schema.split(';').filter(stmt => stmt.trim());

    for (const statement of statements) {
      if (statement.trim()) {
        try {
          await query(statement);
        } catch (err: any) {
          // Log but don't fail on schema errors - the table might already exist with different schema
          // 42703 = column does not exist, 42701 = duplicate column, 42P07 = table exists, 42710 = type exists
          if (err.code === '42703' || err.code === '42701' || err.code === '42P07' || err.code === '42710') {
            console.log('[DB] Skipping schema statement (already exists):', err.message?.substring(0, 80));
          } else {
            throw err;
          }
        }
      }
    }

    console.log('[DB] Schema initialized successfully');

    // Read and execute migrations
    const migrationsPath = path.join(__dirname, 'migrations.sql');
    const migrations = fs.readFileSync(migrationsPath, 'utf-8');

    // Split and execute each statement
    const migrationStatements = migrations.split(';').filter(stmt => stmt.trim());

    for (const statement of migrationStatements) {
      if (statement.trim()) {
        try {
          await query(statement);
        } catch (err: any) {
          // Log but don't fail on migration errors - tables might already exist
          // 42703 = column does not exist, 42701 = duplicate column, 42P07 = table exists, 42710 = type exists
          // 23503 = foreign key constraint violation, 42P01 = relation does not exist
          if (err.code === '42703' || err.code === '42701' || err.code === '42P07' || err.code === '42710' || err.code === '23503' || err.code === '42P01') {
            console.log('[DB] Skipping migration statement (conflict):', err.message?.substring(0, 80));
          } else {
            throw err;
          }
        }
      }
    }

    console.log('[DB] Migrations applied successfully');

    // Read and execute missing tables migration
    const missingTablesPath = path.join(__dirname, 'missing_tables.sql');
    if (fs.existsSync(missingTablesPath)) {
      const missingTables = fs.readFileSync(missingTablesPath, 'utf-8');
      const missingTablesStatements = missingTables.split(';').filter(stmt => stmt.trim());
      for (const statement of missingTablesStatements) {
        if (statement.trim()) {
          try {
            await query(statement);
          } catch (err: any) {
            if (err.code === '42703' || err.code === '42701' || err.code === '42P07' || err.code === '42710' || err.code === '23503' || err.code === '42P01') {
              console.log('[DB] Skipping missing table statement (conflict):', err.message?.substring(0, 80));
            } else {
              console.log('[DB] Error in missing table statement:', err.message);
            }
          }
        }
      }
      console.log('[DB] Missing tables migration applied');
    }

    // Read and execute challenges schema
    try {
      const challengesPath = path.join(__dirname, 'challenges_schema.sql');
      if (fs.existsSync(challengesPath)) {
        const challengesSchema = fs.readFileSync(challengesPath, 'utf-8');
        const challengesStatements = challengesSchema.split(';').filter(stmt => stmt.trim());
        for (const statement of challengesStatements) {
          if (statement.trim()) {
            try {
              await query(statement);
            } catch (err: any) {
              if (err.code !== '42P07' && err.code !== '42710') {
                console.log('[DB] Challenges schema warning:', err.message?.substring(0, 80));
              }
            }
          }
        }
        console.log('[DB] Challenges schema initialized');
      }
    } catch (err) {
      console.error('[DB] Failed to initialize challenges schema:', err);
    }

    // Add description column to games table if it doesn't exist
    try {
      await query(`ALTER TABLE games ADD COLUMN IF NOT EXISTS description TEXT`);
      console.log('[DB] Verified description column in games');
    } catch (err: any) {
      console.log('[DB] Schema check for games.description:', err.message?.substring(0, 100));
    }

    // Add image_url column to games table if it doesn't exist
    try {
      await query(`ALTER TABLE games ADD COLUMN IF NOT EXISTS image_url VARCHAR(500)`);
      console.log('[DB] Verified image_url column in games');
    } catch (err: any) {
      console.log('[DB] Schema check for games.image_url:', err.message?.substring(0, 100));
    }

    // Add thumbnail column to games table if it doesn't exist
    try {
      await query(`ALTER TABLE games ADD COLUMN IF NOT EXISTS thumbnail VARCHAR(500)`);
      console.log('[DB] Verified thumbnail column in games');
    } catch (err: any) {
      console.log('[DB] Schema check for games.thumbnail:', err.message?.substring(0, 100));
    }

    // Add embed_url column to games table if it doesn't exist
    try {
      await query(`ALTER TABLE games ADD COLUMN IF NOT EXISTS embed_url VARCHAR(500)`);
      console.log('[DB] Verified embed_url column in games');
    } catch (err: any) {
      console.log('[DB] Schema check for games.embed_url:', err.message?.substring(0, 100));
    }

    // Add updated_at column to games table if it doesn't exist
    try {
      await query(`ALTER TABLE games ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP`);
      console.log('[DB] Verified updated_at column in games');
    } catch (err: any) {
      console.log('[DB] Schema check for games.updated_at:', err.message?.substring(0, 100));
    }

    // Add bonus_sc column to store_packs table if it doesn't exist
    try {
      await query(`ALTER TABLE store_packs ADD COLUMN IF NOT EXISTS bonus_sc DECIMAL(15, 2) DEFAULT 0`);
      console.log('[DB] Verified bonus_sc column in store_packs');
    } catch (err: any) {
      console.log('[DB] Schema check for store_packs.bonus_sc:', err.message?.substring(0, 100));
    }

    // Note: store_packs table uses 'display_order' column for sorting
    // No column rename needed - column names are consistent

    // Ensure security_alerts has player_id and other expected columns
    try {
      await query(`ALTER TABLE security_alerts ADD COLUMN IF NOT EXISTS player_id INTEGER REFERENCES players(id) ON DELETE CASCADE`);
      await query(`ALTER TABLE security_alerts ADD COLUMN IF NOT EXISTS severity VARCHAR(50) DEFAULT 'info'`);
      await query(`ALTER TABLE security_alerts ADD COLUMN IF NOT EXISTS title VARCHAR(255)`);
      await query(`ALTER TABLE security_alerts ADD COLUMN IF NOT EXISTS message TEXT`);
      await query(`ALTER TABLE security_alerts ADD COLUMN IF NOT EXISTS timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP`);
      await query(`ALTER TABLE security_alerts ADD COLUMN IF NOT EXISTS created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP`);
      console.log('[DB] Verified security_alerts table schema');
    } catch (err: any) {
      console.log('[DB] security_alerts schema update:', err.message?.substring(0, 100));
    }

    // Seed data if tables are empty
    await seedDatabase();
  } catch (error) {
    console.error('[DB] Initialization failed:', error);
    throw error;
  }
};

const seedDatabase = async () => {
  try {
    // Add password_hash column to players table if it doesn't exist
    console.log('[DB] Checking players table schema...');
    try {
      await query(`ALTER TABLE players ADD COLUMN IF NOT EXISTS password_hash VARCHAR(255) NOT NULL DEFAULT ''`);
      console.log('[DB] Verified password_hash column in players');
    } catch (err: any) {
      console.log('[DB] Schema check for password_hash:', err.message?.substring(0, 100));
    }

    // Add username column to players table if it doesn't exist
    try {
      await query(`ALTER TABLE players ADD COLUMN IF NOT EXISTS username VARCHAR(255) UNIQUE`);
      console.log('[DB] Verified username column in players');
    } catch (err: any) {
      console.log('[DB] Schema check for username:', err.message?.substring(0, 100));
    }

    // Update existing players to have usernames if they don't
    console.log('[DB] Ensuring players have usernames...');
    try {
      const playersWithoutUsername = await query(
        `SELECT id, name FROM players WHERE username IS NULL LIMIT 100`
      );

      for (const player of playersWithoutUsername.rows) {
        const username = player.name.toLowerCase().replace(/\s+/g, '') + player.id;
        await query(
          `UPDATE players SET username = $1 WHERE id = $2`,
          [username, player.id]
        );
      }

      if (playersWithoutUsername.rows.length > 0) {
        console.log(`[DB] Updated ${playersWithoutUsername.rows.length} players with usernames`);
      }
    } catch (err: any) {
      console.log('[DB] Username update:', err.message?.substring(0, 100));
    }

    // Apply welcome bonus to all players
    console.log('[DB] Applying welcome bonus to all players...');
    try {
      const bonusResult = await query(
        `UPDATE players SET gc_balance = GREATEST(gc_balance, 10000), sc_balance = GREATEST(sc_balance, 5) WHERE status = 'Active'`
      );
      console.log('[DB] Welcome bonus applied to players');
    } catch (err: any) {
      console.log('[DB] Welcome bonus update:', err.message?.substring(0, 100));
    }

    // Always ensure admin user exists
    console.log('[DB] Ensuring admin user exists...');
    const adminEmail = process.env.ADMIN_EMAIL || 'coinkrazy26@gmail.com';
    const adminRawPassword = process.env.ADMIN_PASSWORD || 'admin123';
    const adminPassword = await bcrypt.hash(adminRawPassword, 10);

    try {
      await query(
        `INSERT INTO admin_users (email, password_hash, name, role, status)
         VALUES ($1, $2, $3, $4, $5)
         ON CONFLICT (email) DO UPDATE SET password_hash = $2`,
        [adminEmail, adminPassword, 'CoinKrazy Admin', 'admin', 'Active']
      );
      console.log(`[DB] Admin user ${adminEmail} ensured`);
    } catch (err: any) {
      console.log('[DB] Admin user setup:', err.message?.substring(0, 100));
    }

    // Check if players table has data
    const result = await query('SELECT COUNT(*) as count FROM players');

    if (result.rows[0].count === 0) {
      console.log('[DB] Seeding database with sample data...');

      // Seed players with proper bcrypt hashes (password: testpass123)
      const playerPassword = await bcrypt.hash('testpass123', 10);
      const players = [
        ['johndoe', 'John Doe', 'john@example.com', playerPassword, 5250, 125, 'Active', 'Full', true],
        ['janesmith', 'Jane Smith', 'jane@example.com', playerPassword, 12000, 340, 'Active', 'Full', true],
        ['mikejohnson', 'Mike Johnson', 'mike@example.com', playerPassword, 2100, 89, 'Active', 'Intermediate', true],
        ['sarahwilson', 'Sarah Wilson', 'sarah@example.com', playerPassword, 8500, 215, 'Active', 'Full', true],
        ['tombrown', 'Tom Brown', 'tom@example.com', playerPassword, 3200, 95, 'Suspended', 'Basic', false],
      ];

      for (const player of players) {
        try {
          await query(
            `INSERT INTO players (username, name, email, password_hash, gc_balance, sc_balance, status, kyc_level, kyc_verified)
             VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)`,
            player
          );
        } catch (err: any) {
          // Player might already exist, that's okay
          if (err.code !== '23505') {
            throw err;
          }
        }
      }

      // Seed games
      const games = [
        ['Mega Spin Slots', 'Slots', 'Internal', 96.5, 'Medium', 'Classic 5-reel slot game with high payouts.', true],
        ['Diamond Poker Pro', 'Poker', 'Internal', 98.2, 'Low', 'Professional poker experience with high stakes.', true],
        ['Bingo Bonanza', 'Bingo', 'Internal', 94.8, 'High', 'Fast-paced bingo action with multiple rooms.', true],
        ['Fruit Frenzy', 'Slots', 'Internal', 95.0, 'Medium', 'Colorful fruit-themed slot machine.', false],
      ];

      for (const game of games) {
        await query(
          `INSERT INTO games (name, category, provider, rtp, volatility, description, enabled)
           VALUES ($1, $2, $3, $4, $5, $6, $7)`,
          game
        );
      }

      // Seed bonuses
      const bonuses = [
        ['Welcome Bonus 100%', 'Deposit', '$100', 100, 10, 1200],
        ['VIP Reload Bonus', 'Reload', '$50', 50, 50, 500],
        ['Free Spins 50', 'Free Spins', '50 Spins', null, 0, 2000],
      ];

      for (const bonus of bonuses) {
        await query(
          `INSERT INTO bonuses (name, type, amount, percentage, min_deposit, max_claims) 
           VALUES ($1, $2, $3, $4, $5, $6)`,
          bonus
        );
      }

      // Seed poker tables
      const pokerTables = [
        ['Diamond Table 1', '$1/$2', 8, 6, 20, 200],
        ['Ruby Table 2', '$5/$10', 8, 5, 100, 1000],
        ['Gold Table 1', '$10/$20', 6, 0, 200, 2000],
        ['Platinum VIP', '$50/$100', 6, 4, 1000, 10000],
        ['Silver Stake 1', '$0.50/$1', 9, 3, 10, 100],
        ['Bronze Beginner', '$0.10/$0.20', 9, 8, 2, 20],
        ['High Roller Suite', '$100/$200', 6, 2, 2000, 20000],
        ['Fast Fold 1', '$1/$2', 6, 45, 20, 200],
        ['Omaha High 1', '$2/$4', 8, 5, 40, 400],
        ['Deep Stack Pro', '$5/$10', 9, 7, 500, 2000],
      ];

      for (const table of pokerTables) {
        await query(
          `INSERT INTO poker_tables (name, stakes, max_players, current_players, buy_in_min, buy_in_max) 
           VALUES ($1, $2, $3, $4, $5, $6)`,
          table
        );
      }

      // Seed bingo games
      const bingoGames = [
        ['Morning Bonanza', '5-line', 42, 1, 500],
        ['Afternoon Special', 'Full Card', 28, 2, 1200],
        ['Evening Rush', '5-line', 0, 1.5, 750],
        ['Night Party', 'Corner', 0, 3, 2000],
        ['Penny Bingo', 'Any line', 156, 0.01, 100],
        ['Speed Bingo', 'Center square', 34, 0.50, 300],
        ['High Stakes Bingo', 'Full Card', 12, 10, 5000],
        ['Community Pot', '4 Corners', 89, 0.25, 400],
        ['Jackpot Jubilee', 'Coverall', 210, 5, 10000],
        ['Lunchtime Quickie', 'Single Line', 45, 0.10, 50],
      ];

      for (const game of bingoGames) {
        await query(
          `INSERT INTO bingo_games (name, pattern, players, ticket_price, jackpot) 
           VALUES ($1, $2, $3, $4, $5)`,
          game
        );
      }

      // Seed sports events
      const sportsEvents = [
        ['NFL', 'Chiefs vs 49ers', 'Live', 124500, '+2.5'],
        ['NBA', 'Lakers vs Celtics', 'Live', 89200, '-1.5'],
        ['Soccer', 'Manchester United vs Liverpool', 'Upcoming', 234100, '+0.5'],
        ['Tennis', 'Australian Open Final', 'Upcoming', 56800, null],
        ['MLB', 'Yankees vs Red Sox', 'Upcoming', 45000, '-110'],
        ['NHL', 'Leafs vs Canadiens', 'Live', 32000, 'O 6.5'],
        ['Boxing', 'Fury vs Usyk', 'Upcoming', 1500000, 'Pickem'],
        ['UFC', 'McGregor vs Chandler', 'Upcoming', 2000000, '-150'],
        ['Golf', 'The Masters - Round 1', 'Upcoming', 75000, 'Scheffler +300'],
        ['Cricket', 'India vs Pakistan', 'Live', 5000000, 'India -140'],
      ];

      for (const event of sportsEvents) {
        await query(
          `INSERT INTO sports_events (sport, event_name, status, total_bets, line_movement)
           VALUES ($1, $2, $3, $4, $5)`,
          event
        );
      }

      // Seed store packs
      const storePacks = [
        ['Starter Pack', 'Perfect for new players', 9.99, 1000, 0, 0, false, false, true, 1],
        ['Gold Bundle', 'Popular choice', 24.99, 3000, 500, 10, true, false, true, 2],
        ['Platinum Pack', 'Best value offer', 49.99, 7000, 2000, 20, false, true, true, 3],
        ['VIP Elite', 'Premium experience', 99.99, 15000, 5000, 30, false, false, true, 4],
        ['Mega Bonus', 'Limited time offer', 14.99, 2000, 200, 15, false, false, true, 5],
      ];

      for (const pack of storePacks) {
        await query(
          `INSERT INTO store_packs (title, description, price_usd, gold_coins, sweeps_coins, bonus_percentage, is_popular, is_best_value, enabled, display_order)
           VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)`,
          pack
        );
      }

      // Seed achievements
      const achievements = [
        ['First Win', 'Win your first game', 'trophy', 'first_win', 'wins', 1, true],
        ['Big Winner', 'Win 100 times', 'crown', 'big_winner', 'wins', 100, true],
        ['High Roller', 'Wager 10,000 gold coins', 'gem', 'high_roller', 'wagered', 10000, true],
        ['Streaker', 'Get a 10 game winning streak', 'fire', 'streaker', 'streak', 10, true],
        ['Rich Player', 'Accumulate 50,000 gold coins', 'diamond', 'rich_player', 'balance', 50000, true],
        ['Slots Master', 'Play slots 500 times', 'star', 'slots_master', 'games_played', 500, true],
        ['Poker Pro', 'Play 100 poker hands', 'spade', 'poker_pro', 'games_played', 100, true],
      ];

      for (const achievement of achievements) {
        await query(
          `INSERT INTO achievements (name, description, icon_url, badge_name, requirement_type, requirement_value, enabled)
           VALUES ($1, $2, $3, $4, $5, $6, $7)`,
          achievement
        );
      }

      // Seed player stats (for seeded players)
      const playerIds = [1, 2, 3, 4];
      for (const playerId of playerIds) {
        await query(
          `INSERT INTO player_stats (player_id, total_wagered, total_won, games_played, favorite_game)
           VALUES ($1, $2, $3, $4, $5)`,
          [playerId, Math.random() * 50000, Math.random() * 25000, Math.floor(Math.random() * 500), 'Slots']
        );
      }

      // Seed scratch ticket designs
      const scratchDesigns = [
        ['Gold Rush', 'Scratch to find hidden gold!', 5, 6, 16.67, 1, 10, null, '#FFD700'],
        ['Lucky Clover', 'Find the 4-leaf clover and win big!', 2, 4, 20, 1, 5, null, '#4CAF50'],
        ['Diamond Dazzle', 'Diamonds are a player\'s best friend!', 10, 9, 15, 5, 10, null, '#00BCD4'],
      ];

      for (const design of scratchDesigns) {
        await query(
          `INSERT INTO scratch_ticket_designs (name, description, cost_sc, slot_count, win_probability, prize_min_sc, prize_max_sc, image_url, background_color)
           VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)`,
          design
        );
      }

      // Seed pull tab designs
      const pullTabDesigns = [
        ['Orange Heat', 'Traditional pull tabs with big wins!', 5, 3, 20, 1, 10, null, '#FF6B35'],
        ['Midnight Stars', 'Pull the stars and reach for the moon!', 1, 3, 25, 1, 5, null, '#3F51B5'],
        ['Royal Jackpot', 'Only for the elite - massive prizes await!', 25, 5, 15, 5, 10, null, '#9C27B0'],
      ];

      for (const design of pullTabDesigns) {
        await query(
          `INSERT INTO pull_tab_designs (name, description, cost_sc, tab_count, win_probability, prize_min_sc, prize_max_sc, image_url, background_color)
           VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)`,
          design
        );
      }

      console.log('[DB] Sample data seeded successfully');
    } else {
      console.log('[DB] Database already contains data, skipping main seed');
    }

    // Always ensure some designs exist for testing if table is empty
    const scratchCount = await query('SELECT COUNT(*) as count FROM scratch_ticket_designs');
    if (parseInt(scratchCount.rows[0].count) === 0) {
      console.log('[DB] Seeding scratch ticket designs...');
      const scratchDesigns = [
        ['Gold Rush', 'Scratch to find hidden gold!', 5, 6, 16.67, 1, 10, null, '#FFD700'],
        ['Lucky Clover', 'Find the 4-leaf clover and win big!', 2, 4, 20, 1, 5, null, '#4CAF50'],
        ['Diamond Dazzle', 'Diamonds are a player\'s best friend!', 10, 9, 15, 5, 10, null, '#00BCD4'],
      ];
      for (const design of scratchDesigns) {
        await query(
          `INSERT INTO scratch_ticket_designs (name, description, cost_sc, slot_count, win_probability, prize_min_sc, prize_max_sc, image_url, background_color)
           VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)`,
          design
        );
      }
    }

    const pullTabCount = await query('SELECT COUNT(*) as count FROM pull_tab_designs');
    if (parseInt(pullTabCount.rows[0].count) === 0) {
      console.log('[DB] Seeding pull tab designs...');
      const pullTabDesigns = [
        ['Orange Heat', 'Traditional pull tabs with big wins!', 5, 3, 20, 1, 10, null, '#FF6B35'],
        ['Midnight Stars', 'Pull the stars and reach for the moon!', 1, 3, 25, 1, 5, null, '#3F51B5'],
        ['Royal Jackpot', 'Only for the elite - massive prizes await!', 25, 5, 15, 5, 10, null, '#9C27B0'],
      ];
      for (const design of pullTabDesigns) {
        await query(
          `INSERT INTO pull_tab_designs (name, description, cost_sc, tab_count, win_probability, prize_min_sc, prize_max_sc, image_url, background_color)
           VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)`,
          design
        );
      }
    }

    const storePacksCount = await query('SELECT COUNT(*) as count FROM store_packs');
    if (parseInt(storePacksCount.rows[0].count) === 0) {
      console.log('[DB] Seeding store packs...');
      const storePacks = [
        ['Starter Pack', 'Perfect for new players', 9.99, 1000, 0, 0, false, false, true, 1],
        ['Gold Bundle', 'Popular choice', 24.99, 3000, 500, 10, true, false, true, 2],
        ['Platinum Pack', 'Best value offer', 49.99, 7000, 2000, 20, false, true, true, 3],
        ['VIP Elite', 'Premium experience', 99.99, 15000, 5000, 30, false, false, true, 4],
        ['Mega Bonus', 'Limited time offer', 14.99, 2000, 200, 15, false, false, true, 5],
      ];

      for (const pack of storePacks) {
        await query(
          `INSERT INTO store_packs (title, description, price_usd, gold_coins, sweeps_coins, bonus_percentage, is_popular, is_best_value, enabled, display_order)
           VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)`,
          pack
        );
      }
    }

    // Game seeding
    const gameCount = await query('SELECT COUNT(*) as count FROM games');
    if (parseInt(gameCount.rows[0].count) === 0) {
      console.log('[DB] Seeding starter games...');
      const starterGames = [
        ['Knights vs Barbarians', 'Slots', 'External', 96.4, 'Medium', 'Experience epic battles between knights and barbarians', true, 'https://clashofslots.com/wp-content/uploads/2025/12/knights-vs-barbarians-logo-1.jpg', 'knights-vs-barbarians', 'https://demogamesfree.pragmaticplay.net/gs2c/openGame.do?stylename=demo_clienthub&lang=en&cur=USD&websiteUrl=https%3A%2F%2Fclienthub.pragmaticplay.com%2F&gcpif=2273&gameSymbol=vs10cenrlgdevl&jurisdiction=99'],
        ['Emerald King Wheel of Wealth', 'Slots', 'External', 96.5, 'Medium', 'Spin the wheel of fortune in this luxurious emerald-themed slot adventure', true, 'https://clashofslots.com/wp-content/uploads/2025/12/emerald-king-wheel-of-wealth-logo.jpg', 'emerald-king', 'https://demogamesfree.pragmaticplay.net/gs2c/openGame.do?stylename=demo_clienthub&lang=en&cur=USD&websiteUrl=https%3A%2F%2Fclienthub.pragmaticplay.com%2Fru%2F&gcpif=2273&gameSymbol=vs10dublin&jurisdiction=99'],
        ['3 Blades & Blessings', 'Slots', 'External', 96.2, 'High', 'Mythological adventure with ancient gods and sacred treasures', true, 'https://clashofslots.com/wp-content/uploads/2026/01/3-blades-blessings-logo.jpg', '3-blades', 'https://released.playngonetwork.com/casino/ContainerLauncher?pid=2&gid=3bladesandblessings&lang=en_GB&practice=1&channel=desktop&demo=2'],
        ['Arcanum', 'Slots', 'External', 96.3, 'Medium', 'Mystical magical experience with arcane symbols', true, 'https://clashofslots.com/wp-content/uploads/2025/11/arcanum-logo.jpg', 'arcanum', 'https://static-stage.contentmedia.eu/ecf3/index.html?gameid=10256&operatorid=44&currency=EUR&mode=demo&device=desktop&gamename=arcanum&language=en_gb&xdm=1&capi=https%3A%2F%2Fgc5-stage.contentmedia.eu%2Fcapi&papi=https%3A%2F%2Fpapi-stage.contentmedia.eu'],
        ['Dragon Boyz', 'Slots', 'External', 96.1, 'High', 'Roaring action with dragons and fiery wins', true, 'https://clashofslots.com/wp-content/uploads/2025/12/dragon-boyz-logo.jpg', 'dragon-boyz', 'https://playin.com/embed/v1/demo/dragonboyz000000'],
        ['Big Joker', 'Slots', 'External', 95.8, 'Medium', 'Classic fruit-themed slot with a big joker surprise!', true, 'https://via.placeholder.com/300x300?text=Big+Joker', 'big-joker', 'https://free-slots.games/game/BigJokerCT/']
      ];

      for (const game of starterGames) {
        await query(
          `INSERT INTO games (name, category, provider, rtp, volatility, description, enabled, image_url, slug, embed_url)
           VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)`,
          game
        );
      }
      console.log('[DB] Starter games seeded');
    }

    // Seed AI employees if table is empty
    const aiCount = await query('SELECT COUNT(*) as count FROM ai_employees');
    if (parseInt(aiCount.rows[0].count) === 0) {
      console.log('[DB] Seeding AI employees...');
      const aiEmployees = [
        ['ai-1', 'LuckyAI', 'Game Optimizer', 'active', ['Adjust RTP', 'Game Balance']],
        ['ai-2', 'SecurityAI', 'Security Monitor', 'active', ['Fraud Detection', 'Account Security']],
        ['ai-3', 'SlotsAI', 'Slots Specialist', 'active', ['Slots Management', 'Payout Optimization']],
        ['ai-4', 'JoseyAI', 'Poker Engine', 'idle', []],
        ['ai-5', 'SocialAI', 'Community Manager', 'active', ['Chat Moderation', 'Event Hosting']],
        ['ai-6', 'PromotionsAI', 'Marketing', 'active', ['Promotions', 'Bonuses']]
      ];

      for (const ai of aiEmployees) {
        await query(
          `INSERT INTO ai_employees (id, name, role, status, duties)
           VALUES ($1, $2, $3, $4, $5)`,
          ai
        );
      }
      console.log('[DB] AI employees seeded');
    }

    // Seed default casino settings
    const settingsCount = await query('SELECT COUNT(*) as count FROM casino_settings');
    if (parseInt(settingsCount.rows[0].count) === 0) {
      console.log('[DB] Seeding default casino settings...');
      const settings = [
        ['maintenance_mode', 'false', 'boolean', 'Whether the platform is in maintenance mode'],
        ['system_health', 'Optimal', 'string', 'Current system health status'],
        ['slots_config', JSON.stringify({ rtp: 95, minBet: 0.01, maxBet: 100 }), 'json', 'Global configuration for slots'],
        ['poker_config', JSON.stringify({ rtp: 95, minBuyIn: 10, maxBuyIn: 1000, houseCommission: 5 }), 'json', 'Global configuration for poker'],
        ['bingo_config', JSON.stringify({ rtp: 85, minTicketPrice: 0.5, maxTicketPrice: 50, houseCommission: 15 }), 'json', 'Global configuration for bingo'],
        ['sportsbook_config', JSON.stringify({ rtp: 92, minBet: 1, maxBet: 1000, minParlay: 3, maxParlay: 10, houseCommission: 8 }), 'json', 'Global configuration for sportsbook']
      ];

      for (const s of settings) {
        await query(
          `INSERT INTO casino_settings (setting_key, setting_value, data_type, description)
           VALUES ($1, $2, $3, $4)`,
          s
        );
      }
      console.log('[DB] Casino settings seeded');
    }

    // Always ensure payment methods exist
    const pmCount = await query('SELECT COUNT(*) as count FROM payment_methods');
    if (parseInt(pmCount.rows[0].count) === 0) {
      console.log('[DB] Seeding default payment methods...');
      const paymentMethods = [
        ['Credit Card', 'stripe', true, JSON.stringify({
          api_key: process.env.STRIPE_PUBLIC_KEY || 'REPLACE_ENV.STRIPE_PUBLIC_KEY',
          secret_key: process.env.STRIPE_SECRET_KEY || 'REPLACE_ENV.STRIPE_SECRET_KEY',
          mode: 'live'
        })],
        ['Google Pay', 'google_pay', true, JSON.stringify({
          merchant_id: 'BCR2DN6T7X7X7X7X',
          merchant_name: 'CoinKrazy',
          gateway: 'stripe',
          mode: 'live'
        })]
      ];

      for (const method of paymentMethods) {
        await query(
          `INSERT INTO payment_methods (name, provider, is_active, config)
           VALUES ($1, $2, $3, $4)`,
          method
        );
      }
    }
  } catch (error) {
    console.error('[DB] Seeding failed:', error);
    throw error;
  }
};

// Export initialization for manual run if needed
export default initializeDatabase;
